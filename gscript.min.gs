/* Google Script Backend     | Version: 0.2    | github.com/felipeandres254/gscript                 */
!(function() { $CONFIG=PropertiesService.getScriptProperties().getProperties();Object.keys($CONFIG).forEach(function(key){key.split(".").forEach(function(part,idx){if(!eval("$CONFIG."+key.split(".").splice(0,idx+1).join("."))){eval("$CONFIG."+key.split(".").splice(0,idx+1).join(".")+" = {}")}});eval("$CONFIG."+key+" = "+$CONFIG[key]);delete $CONFIG[key]});$SS=SpreadsheetApp.getActiveSpreadsheet();Database={};Database.create=function(b,a){if($SS.getSheetByName(b)!==null){throw new TableExistsError(b)}a(new Table(b))};Database.drop=function(b){var a=$SS.getSheetByName(b);if(!a){throw new TableNotFoundError(b)}$SS.deleteSheet(a)};Database.table=function(a){if($SS.getSheetByName(a)===null){throw new TableNotFoundError(a)}return new Table(a)};function Table(a){if($SS.getSheetByName(a)===null){Utils.lock(function(){var b=$SS.insertSheet(a);b.deleteRows(2,b.getMaxRows()-2);b.deleteColumns(2,b.getMaxColumns()-1);b.setRowHeight(1,25).setRowHeight(2,25).setColumnWidth(1,150);b.getRange(1,1,1,b.getMaxColumns()).setFontWeight("bold");b.getRange(1,1,2,b.getMaxColumns()).setNumberFormat("@").setHorizontalAlignment("left").setVerticalAlignment("middle");b.setFrozenRows(1)})}this.sheet=$SS.getSheetByName(a);this.fields={_:this.sheet.getRange(1,1,1,this.sheet.getMaxColumns())};this.fields._.getValues()[0].forEach(function(b){if(b!==""){this.fields[b]=Field.read(this,b)}},this);this.$DATA=this.sheet.getRange(2,1,this.sheet.getMaxRows()-1,this.sheet.getMaxColumns()).getValues();this.$DATA=this.$DATA.map(function(b){if(b.some(function(c){return c!==""})){return this.fields._.getValues()[0].reduce(function(d,e,c){d[e]=b[c];return d},{})}else{return null}},this).filter(function(b){return b!==null});this.data=this.$DATA.slice(0)}Table.prototype.primary=function(b){var a=this.fields._.getValues()[0].filter(function(c){return c!==""});if(a.some(function(c){return this.fields[c].attrs.indexOf("primary")!=-1},this)){throw new TableIntegrityError("Table has a Primary Key already")}this.fields[b]=(new Field(b,"hex",["primary"],10,this)).write()};Table.prototype.unique=function(a){a=a||this.fields._.getValues()[0][this.fields._.getValues()[0].length-1];this.fields[a]=this.fields[a].attr("unique")};Table.prototype.nullable=function(a){a=a||this.fields._.getValues()[0][this.fields._.getValues()[0].length-1];this.fields[a]=this.fields[a].attr("nullable")};Table.prototype.string=function(a,b){this.fields[a]=(new Field(a,"string",[],b||null,this)).write();return this};Table.prototype.where=function(field,compare,value){value=((typeof value==="undefined")||(value===null))?"":value.toString();this.data=this.data.filter(function(row){var data=((typeof row[field]==="undefined")||(row[field]===null))?"":row[field].toString();if(compare=="~="){return eval(value+".test('"+data+"')")}else{if(compare!="="){return eval("'"+data+"'"+compare+"'"+value+"'")}else{return data===value}}});return this};Table.prototype.get=function(){return this.data};Table.prototype.all=function(){return this.$DATA};Table.prototype.insert=function(a){a=this.fields._.getValues()[0].map(function(b){if(!this.fields[b].validate(a[b])){return null}return a[b]?a[b].toString():""},this);if(a.some(function(b){b===null})){throw new TableInvalidRowError}Utils.lock(function(b){if(b.$DATA.length>0){b.sheet.insertRowBefore(2)}b.sheet.getRange(2,1,1,b.sheet.getMaxColumns()).setValues([a])},this)};Table.prototype.update=function(a){var b=[];this.fields._.getValues()[0].forEach(function(c){if(this.fields[c].attrs.indexOf("primary")!=-1){b=[c].concat(b)}if(this.fields[c].attrs.indexOf("unique")!=-1){b.push(c)}},this);b.forEach(function(c){if(a[c]&&this.data.length==1&&!this.fields[c].validate(a[c])){throw new TableIntegrityError("Primary Key or unique value already exists in Table data")}if(a[c]&&this.data.length>1){delete a[c]}},this);this.data.forEach(function(d){var c=this.fields._.getValues()[0].map(function(e){if((typeof a[e]==="undefined")||(a[e]===null)){if((typeof d[e]==="undefined")||(d[e]===null)){return""}else{return d[e].toString()}}else{if(!this.fields[e].validate(a[e])){throw new FieldValueError(e,a[e])}return a[e].toString()}},this);Utils.lock(function(f){var e;Database.table(f.sheet.getName()).$DATA.some(function(h,g){if(h[b[0]]===d[b[0]]){e=g;return true}});if(e===parseInt(e,10)){f.sheet.getRange(e+2,1,1,c.length).setValues([c])}},this)},this)};Table.prototype.remove=function(){var a;this.fields._.getValues()[0].some(function(b){if(this.fields[b].attrs.indexOf("primary")!=-1){a=b;return true}},this);this.data.forEach(function(b){Utils.lock(function(d){var c;Database.table(d.sheet.getName()).$DATA.some(function(f,e){if(f[a]===b[a]){c=e;return true}});if(d.sheet.getMaxRows()==2){d.sheet.getRange(c+2,1,1,d.sheet.getMaxColumns()).clearContent()}else{d.sheet.deleteRow(c+2)}},this)},this)};TableExistsError=function(a){this.name="TableExistsError";this.table=a;this.message="The Table '"+a+"' exists already";this.stack=(new Error).stack};TableExistsError.prototype=Object.create(Error.prototype);TableExistsError.prototype.constructor=TableExistsError;TableNotFoundError=function(a){this.name="TableNotFoundError";this.table=a;this.message="The Table '"+a+"' does not exist";this.stack=(new Error).stack};TableNotFoundError.prototype=Object.create(Error.prototype);TableNotFoundError.prototype.constructor=TableNotFoundError;TableIntegrityError=function(a){this.name="TableIntegrityError";this.message=a;this.stack=(new Error).stack};TableIntegrityError.prototype=Object.create(Error.prototype);TableIntegrityError.prototype.constructor=TableIntegrityError;TableInvalidRowError=function(){this.name="TableInvalidRowError";this.message="Can't insert invalid row to Table";this.stack=(new Error).stack};TableInvalidRowError.prototype=Object.create(Error.prototype);TableInvalidRowError.prototype.constructor=TableInvalidRowError;function Field(b,c,a,e,d){this.name=b;this.type=c;this.attrs=a||[];this.attrs.sort();if(e){this.length=e}if(d){this.table=d}}Field.read=function(g,c){var a=g.fields._.getValues()[0].indexOf(c);if(a==-1){throw new FieldReadError}var e=g.fields._.getNotes()[0][a];var d=e.split("\n")[0].split(",")[0];var f=e.split("\n")[0].indexOf(",")==-1?null:parseInt(e.split("\n")[0].split(",")[1],10);var b=e.indexOf("\n")==-1?[]:e.split("\n")[1].split(",");return new Field(c,d,b,f,g)};Field.prototype.write=function(){if(!this.table){throw new FieldWriteError}if(Object.keys(this.table.fields).indexOf(this.name)!==-1){throw new TableIntegrityError("Table has a Field with the same name")}return Utils.lock(function(c){if(c.field.table.sheet.getRange(1,1,1,c.field.table.sheet.getMaxColumns()).getValues()[0][0]!=""){c.field.table.sheet.insertColumnAfter(c.field.table.sheet.getMaxColumns())}var a=c.field.table.sheet.getRange(1,c.field.table.sheet.getMaxColumns(),1,1);var b=c.field.type+(c.field.length?(","+c.field.length):"")+(c.field.attrs.length>0?("\n"+c.field.attrs.join("\n")):"");a.setValues([[c.field.name]]).setNotes([[b]]);c.field.table.fields._=c.field.table.sheet.getRange(1,1,1,c.field.table.sheet.getMaxColumns());return c.field},{field:this})};Field.prototype.attr=function(a){return Utils.lock(function(d){if(d.field.attrs.indexOf(a)==-1){d.field.attrs.push(a);d.field.attrs.sort();var b=d.field.table.fields._.getValues()[0].indexOf(d.field.name);var c=d.field.type+(d.field.length?(","+d.field.length):"")+(d.field.attrs.length>0?("\n"+d.field.attrs.join("\n")):"");d.field.table.sheet.getRange(1,b+1,1,1).setNotes([[c]])}d.field.table.fields._=d.field.table.sheet.getRange(1,1,1,d.field.table.sheet.getMaxColumns());return d.field},{field:this})};Field.prototype.validate=function(c){if(c===null){return this.attrs.indexOf("nullable")!=-1}if(!c){return false}var a;switch(this.type){case"string":a=this.type.replace("string",".")+(this.length?("{"+this.length+"}"):"*");break;case"hex":a=this.type.replace("hex","[a-f0-9]")+(this.length?("{"+this.length+"}"):"*");break;case"num":a=this.type.replace("num","[0-9]")+(this.length?("{"+this.length+"}"):"*");break;case"alpha":a=this.type.replace("alpha","[a-z]")+(this.length?("{"+this.length+"}"):"*");break;case"alphanum":a=this.type.replace("alphanum","[a-z0-9]")+(this.length?("{"+this.length+"}"):"*");break;case"email":a="(\\w|-|.)+@(\\w+\\.)+[a-z]+";break;case"datetime":a="\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}";break;case"date":a="\\d{4}-\\d{2}-\\d{2}";break;case"time":a="\\d{2}:\\d{2}:\\d{2}";break;case"boolean":a="(true|false)";break;case"int":a="[+-]?\\d+";break;case"float":a="[+-]?\\d+(\\.\\d+)?";break;default:throw new FieldValidationError(this.type)}a=new RegExp("^"+a+"$");var b=a.test(c.toString().toLowerCase());if(!b){return false}if(!this.table||(this.attrs.indexOf("primary")==-1&&this.attrs.indexOf("unique")==-1)){return true}return !this.table.$DATA.some(function(d){return d[this.name]===c},this)};FieldReadError=function(){this.name="FieldReadError";this.message="Can't read Field from Table";this.stack=(new Error).stack};FieldReadError.prototype=Object.create(Error.prototype);FieldReadError.prototype.constructor=FieldReadError;FieldWriteError=function(){this.name="FieldWriteError";this.message="Can't write Field to Table";this.stack=(new Error).stack};FieldWriteError.prototype=Object.create(Error.prototype);FieldWriteError.prototype.constructor=FieldWriteError;FieldValueError=function(b,a){this.name="FieldValueError";this.field=b;this.value=a;this.message="Field value '"+a+"' is invalid for '"+b+"'";this.stack=(new Error).stack};FieldValueError.prototype=Object.create(Error.prototype);FieldValueError.prototype.constructor=FieldValueError;FieldValidationError=function(a){this.name="FieldValidationError";this.type=a;this.message="There is no validation rule for '"+a+"'";this.stack=(new Error).stack};FieldValidationError.prototype=Object.create(Error.prototype);FieldValidationError.prototype.constructor=FieldValidationError;String.prototype.sha1=function(){var d="",b=Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_1,this);for(var c=0;c<b.length;c++){var a=b[c]+(b[c]<0?256:0);d+=(a.toString(16).length==1?"0":"")+a.toString(16)}return d};Utils={};Utils.lock=function(a,d){var c=LockService.getScriptLock();while(!c.hasLock()){c.tryLock(1000)}try{return a(d)}catch(b){c.releaseLock();throw b}finally{if(c.hasLock()){c.releaseLock()}}};Date.prototype.getWeek=function(){var a=new Date(this.getFullYear(),0,1);var b=(this-a)/86400000;return Math.ceil((b+a.getDay()+1)/7)}; })();
