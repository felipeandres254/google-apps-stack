/* Google Script Backend     | Version: v0.0     | github.com/felipeandres254/gscript-backend     */
function Database(a){if(!a)throw new DatabaseTableError;a="string"==typeof a?a:a.getName();var b=$SHEET.getSheetByName(a);if(null===b)throw new TableNotFoundError(a);this.table=b,this.headers=b.getSheetValues(1,1,1,b.getMaxColumns())[0],this.headers=this.headers.map(function(a){return a.toLowerCase().replace(/ |-/g,"_")}),this.$data=b.getSheetValues(2,1,b.getMaxRows(),b.getMaxColumns()),this.$data=this.$data.map(function(a,b){return a.some(function(a){return""!==a})?{_index:b,values:a}:null}).filter(function(a){return null!==a}),this.$data=this.$data.map(function(a){return this.headers.reduce(function(b,c,d){return b[c]=a.values[d],b},{_index:a._index})},this),this.data=JSON.parse(JSON.stringify(this.$data))}function Model(a){if(!this.table)throw new ModelTableError;var b={id:{type:"hex,10",tags:["primary"],index:0,value:null,valid:!1},created:{type:"datetime",tags:[],index:-3,value:null,valid:!1},updated:{type:"datetime",tags:[],index:-2,value:null,valid:!1},deleted:{type:"datetime",tags:["optional"],index:-1,value:null,valid:!0}};Object.keys(b).forEach(function(a){this.fields[a]=b[a]},this),a&&a.constructor===Object&&0!==Object.keys(a).length&&Object.keys(this.fields).forEach(function(b){this.fields[b].value=a[b]&&null!==a[b]?a[b]:null},this);var c=this.fields,d=Object.keys(c).filter(function(a){return c[a].index>=0});d.sort(function(a,b){return c[a].index<c[b].index?-1:c[a].index>c[b].index?1:0});var e=Object.keys(c).filter(function(a){return c[a].index<0});e.sort(function(a,b){return c[a].index<c[b].index?-1:c[a].index>c[b].index?1:0}),this.headers=d.concat(e);try{Database.create(this.table,this.headers)}catch(a){}Database.call(this,this.table)}function ValidationError(a){this.name="ValidationError",this.type=a,this.message="Unknown validation type '"+a.toString()+"'",this.stack=(new Error).stack}function DatabaseIntegrityError(a,b){this.name="DatabaseIntegrityError",this.table=a,this.id=b,this.message="The ID '"+b+"' already exists in table '"+a+"'",this.stack=(new Error).stack}function TableNotFoundError(a){this.name="TableNotFoundError",this.table=a,this.message="The table '"+a+"' does not exist",this.stack=(new Error).stack}function TableExistsError(a){this.name="TableExistsError",this.table=a,this.message="The table '"+a+"' already exists",this.stack=(new Error).stack}function FieldNotFoundError(a,b){this.name="FieldNotFoundError",this.field=a,this.table=b,this.message="The field '"+a+"' does not exist in table '"+b+"'",this.stack=(new Error).stack}function InvalidOperatorError(a,b){this.name="InvalidOperatorError",this.operator=a,this.values=b,this.message="The operator should be one of '"+b.join("', '")+"'",this.stack=(new Error).stack}function InvalidRegexError(a){this.name="InvalidRegexError",this.regex=a,this.message="The value '"+a.toString()+"' is not a valid RegEx",this.stack=(new Error).stack}function ModelTableError(){this.name="ModelTableError",this.message="The Model doesn't have an associated table",this.stack=(new Error).stack}function ModelNotFoundError(a,b){this.name="ModelNotFoundError",this.model=a,this.id=b,this.message=a+" with ID '"+b+"' does not exist",this.stack=(new Error).stack}function ModelExistsError(a,b){this.name="ModelExistsError",this.model=a,this.id=b,this.message=a+" with ID '"+b+"' already exists",this.stack=(new Error).stack}function InvalidModelError(a,b){this.name="InvalidModelError",this.fields=b,this.message=a+" fields are invalid: '"+b.join("', '")+"'",this.stack=(new Error).stack}var Utils={};Utils.sha1=function(a){for(var b="",c=Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_1,a),d=0;d<c.length;d++){var e=c[d]+(c[d]<0?256:0);b+=(1==e.toString(16).length?"0":"")+e.toString(16)}return b},Utils.lock=function(a,b){for(var c=LockService.getScriptLock();!c.hasLock();)c.tryLock(1e3);try{return a(b)}catch(a){throw c.releaseLock(),a}c.hasLock()&&c.releaseLock()},Utils.validate=function(a,b){if(/^string,?/.test(a))return""!==b&&(!/,\d+$/.test(a)||b.length===parseInt(a.split(",")[1]));if(/^hex,?/.test(a))return!!/^[a-f0-9]+$/.test(b.toLowerCase())&&(!/,\d+$/.test(a)||b.length===parseInt(a.split(",")[1]));if(/^alphanum,?/.test(a))return!!/^[a-z0-9]+/.test(b.toLowerCase())&&(!/,\d+$/.test(a)||b.length===parseInt(a.split(",")[1]));if(/^alpha,?/.test(a))return!!/^[a-z]+$/.test(b.toLowerCase())&&(!/,\d+$/.test(a)||b.length===parseInt(a.split(",")[1]));if(/^email$/.test(a))return/[\w-\.]+@(\w+\.)+[a-z]+/.test(b);if(/^datetime$/.test(a))return/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}$/.test(b.substr(0,19).replace("T"," "));if(/^date$/.test(a))return/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(b.substr(0,10));if(/^time$/.test(a))return/^[0-9]{2}:[0-9]{2}:[0-9]{2}$/.test(b.substr(11,8));if(/^int$/.test(a))return/^[+-]?[0-9]+$/.test(b);if(/^float$/.test(a))return/^[+-]?[0-9]+(\.[0-9]+)?$/.test(b);if(/^boolean$/.test(a))return b===!0||b===!1;throw new ValidationError(a)},Database.table=function(a){return new Database(a)},Database.create=function(a,b){var c=$SHEET.getSheetByName(a);if(null!==c)throw new TableExistsError(a);return b.indexOf("id")!=-1&&b.splice(b.indexOf("id"),1),b.unshift("id"),Utils.lock(function(){var c=$SHEET.insertSheet(a);return c.deleteRows(2,c.getMaxRows()-2),c.deleteColumns(2,c.getMaxColumns()-1),c.setRowHeight(1,25).setRowHeight(2,25).setColumnWidth(1,150),c.getRange(1,1,2,b.length).setValues([b,b.map(function(a){return""})]),c.getRange(1,1,1,b.length).setFontWeight("bold"),c.getRange(1,1,2,b.length).setHorizontalAlignment("left").setVerticalAlignment("middle"),c.setFrozenRows(1),Database.table(a)})},Database.prototype.insert=function(a){Utils.lock(function(b){if(b.data=JSON.parse(JSON.stringify(b.$data)),1===b.where("id","=",a.id).get().length)throw new DatabaseIntegrityError(b.table.getName(),a.id);var c=b.headers.map(function(b){return"undefined"==typeof a[b]||null===a[b]?"":a[b]}),d=b.table.getSheetValues(2,1,1,b.table.getMaxColumns())[0];d.some(function(a){return""!==a})&&b.table.insertRowBefore(2);var e=b.table.getRange(2,1,1,b.table.getMaxColumns());e.setValues([c])},this)},Database.prototype.where=function(header,compare,value){if(this.headers.indexOf(header)==-1)throw new FieldNotFoundError(header,this.table);if(["<","<=","=","!=","~=",">=",">"].indexOf(compare)==-1)throw new InvalidOperatorError(compare,["<","<=","=","!=","~=",">=",">"]);if("~="==compare&&value.constructor!==RegExp)throw new InvalidRegexError(value);return this.data=this.data.filter(function(row){return"~="==compare?eval(value.toString()+".test('"+row[header]+"')"):"="!=compare?eval("'"+row[header]+"'"+compare+"'"+value.toString()+"'"):row[header]===value.toString()}),this},Database.prototype.get=function(){return this.data.map(function(a){return delete a._index,a})},Database.prototype.update=function(a){Utils.lock(function(b){b.data.forEach(function(c){var d=b.headers.map(function(b){return"undefined"==typeof a[b]||null===a[b]?c[b]:"id"===b?c[b]:a[b]}),e=Database.table(b.table.getName()).where("id","=",c.id).data[0]._index;b.table.getRange(e+2,1,1,d.length).setValues([d])})},this)},Database.prototype.remove=function(){Utils.lock(function(a){a.data.forEach(function(b){var c=Database.table(a.table.getName()).where("id","=",b.id).data[0]._index;2==a.table.getMaxRows()?a.table.getRange(c+2,1,1,a.table.getMaxColumns()).clear():a.table.deleteRow(c+2)},this)},this)},Model.prototype=Object.create(Database.prototype),Model.prototype.constructor=Model,Model.prototype.validate=function(a){return Object.keys(this.fields).forEach(function(a){return null===this.fields[a].value&&this.fields[a].tags.indexOf("optional")!=-1?void(this.fields[a].valid=!0):void(this.fields[a].valid=Utils.validate(this.fields[a].type,this.fields[a].value))},this),a&&Object.keys(this.fields).forEach(function(a){this.fields[a].tags.indexOf("primary")==-1&&this.fields[a].tags.indexOf("unique")==-1||this.fields[a].valid&&(this.fields[a].valid=!this.$data.some(function(b){return b[a]===this.fields[a].value},this))},this),Object.keys(this.fields).filter(function(a){return!this.fields[a].valid},this)},Model.prototype.all=function(){var models=this.$data.map(function(data){var model=eval("new "+this.constructor.name+"("+JSON.stringify(data)+")");return delete model.data,model},this);return this.fields.deleted&&(models=models.filter(function(a){return null===a.fields.deleted.value})),models},Model.prototype.get=function(){var models=this.data.map(function(data){var model=eval("new "+this.constructor.name+"("+JSON.stringify(data)+")");return delete model.data,model},this);return models},Model.prototype.find=function(a){this.data=JSON.parse(JSON.stringify(this.$data));var b=this.where("id","=",a).get();return this.fields.deleted&&(b=b.filter(function(a){return null===a.fields.deleted.value})),1===b.length?b[0]:null},Model.prototype.removed=function(){return this.fields.deleted?this.where("deleted","!=","").get():[]},Model.prototype.save=function(){if(this.fields.updated.value=(new Date).toISOString().substr(0,19).replace("T"," "),this.fields.id.value){if(!this.$data.some(function(a){return a.id===this.fields.id.value},this))throw new ModelNotFoundError(this.constructor.name,this.fields.id.value);var b=this.validate();if(0!==b.length)throw new InvalidModelError(this.constructor.name,b);this.data=JSON.parse(JSON.stringify(this.$data)),this.where("id","=",this.fields.id.value).update(this.toJSON(!0))}else{var a=Utils.sha1(this.constructor.name+" "+this.fields.updated.value).substr(0,10);if(this.$data.some(function(b){return b.id===a}))throw new ModelExistsError(this.constructor.name,a);this.fields.id.value=a,this.fields.created.value=this.fields.updated.value;var b=this.validate(!0);if(0!==b.length)throw new InvalidModelError(this.constructor.name,b);this.insert(this.toJSON(!0))}},Model.prototype.remove=function(a){this.fields.id.value&&(a||!this.fields.deleted?Database.table(this.table).where("id","=",this.fields.id.value).remove():this.fields.deleted.value||(this.fields.deleted.value=(new Date).toISOString().substr(0,19).replace("T"," "),this.data=JSON.parse(JSON.stringify(this.$data)),this.where("id","=",this.fields.id.value).update(this.toJSON(!0))))},Model.prototype.restore=function(){this.fields.id.value&&this.fields.deleted&&this.fields.deleted.value&&(this.fields.deleted.value="",this.data=JSON.parse(JSON.stringify(this.$data)),this.where("id","=",this.fields.id.value).update(this.toJSON(!0)))},Model.prototype.toString=function(){return"["+this.constructor.name+" "+this.fields.id.value+"]"},Model.prototype.toJSON=function(a){var b=this.fields;return Object.keys(b).reduce(function(c,d){return(a||b[d].tags.indexOf("hidden")==-1)&&(c[d]=b[d].value?b[d].value:"","datetime"===b[d].type&&(c[d]=c[d].substr(0,19).replace("T"," ")),"date"===b[d].type&&(c[d]=c[d].substr(0,10)),"time"===b[d].type&&(c[d]=c[d].substr(11,8))),c},{})},ValidationError.prototype=Object.create(Error.prototype),ValidationError.prototype.constructor=ValidationError,DatabaseIntegrityError.prototype=Object.create(Error.prototype),DatabaseIntegrityError.prototype.constructor=DatabaseIntegrityError,TableNotFoundError.prototype=Object.create(Error.prototype),TableNotFoundError.prototype.constructor=TableNotFoundError,TableExistsError.prototype=Object.create(Error.prototype),TableExistsError.prototype.constructor=TableExistsError,FieldNotFoundError.prototype=Object.create(Error.prototype),FieldNotFoundError.prototype.constructor=FieldNotFoundError,InvalidOperatorError.prototype=Object.create(Error.prototype),InvalidOperatorError.prototype.constructor=InvalidOperatorError,InvalidRegexError.prototype=Object.create(Error.prototype),InvalidRegexError.prototype.constructor=InvalidRegexError,ModelTableError.prototype=Object.create(Error.prototype),ModelTableError.prototype.constructor=ModelTableError,ModelNotFoundError.prototype=Object.create(Error.prototype),ModelNotFoundError.prototype.constructor=ModelNotFoundError,ModelExistsError.prototype=Object.create(Error.prototype),ModelExistsError.prototype.constructor=ModelExistsError,InvalidModelError.prototype=Object.create(Error.prototype),InvalidModelError.prototype.constructor=InvalidModelError;
